<? session_start();?>
<!--
File description:




 -->



<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
</head>
<body>
<div class="top container col-md-12 text-center bg-primary">
    <h1>אַלע װערק פֿון שלום עליכם</h1>
</div>
<div class="current-edit container text-center">
    <h2>דערווייַל עדיטינג: Volume 1, Book 16</h2>
</div>


<?php
/*
My Dev Repo: 
https://499sholem.googlecode.com/svn/trunk/

PATH to my mulitlab sandbox: 
/mounts/u-zon-d2/ugrad/mtlank2/HTML/499sholem

*/



//The following php file is needed for getters/setters of directories, running remote server commands,  
require "utility.php";









//VARIABLES:
//This variable holds the directory (the book) of the containing OCR file
$book = "book";//$_POST['book'];

//This variable holds the exact OCR file, ie the page
$page = "0016";//$_POST["page"];

//This variable holds the name of the user that edited the file
$user = "someGuy";

//This variable holds the absolute Multilab file path of the where the currently edited user file is, in other words this is where the file being edited is stored on the server. (this will have to be passed via cgi search function)
$locationOfOcrFile = (file_get_contents('constants/ocrFilesPath.txt'))."/".$book."/".$page;  //the concatenation of the 0016 hopefully will come from the search function
//echo "Location of ocr file: ".$locationOfOcrFile."<br>";


//This holds the absolute Multilab file path of where the crowd-sourced changes will be saved
$locationOfLogFiles =realpath(__DIR__)."/"."logs"; //Make this relative once you know the setup of your system
//echo "Location of log files: ".$locationOfLogFiles."<br>";







//POST EXECUTION (the main heavy-lifting): 

//The following POST method will apply the edited changes that the user made after they click on the button to make those changes
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['ocrMakeChange']) ){

	//Make a new text file named userEditsFileAtTime, which is comprised of the contents of the file before the user made any changes
	$preEditFileName = "_".$user."~".$book."~".$page."~".time();
	//echo $preEditFileName."<br>";

	//Save the pre-edited version of the file
	file_put_contents($locationOfLogFiles."/".$preEditFileName, file_get_contents($locationOfOcrFile));

	//Get the text that was just edited by the user
	$textChangeFromUser = $_POST['editedText'];
	
	//Replace the main repo OCR file with the newly edited text
	file_put_contents($locationOfOcrFile, $textChangeFromUser);
	
	//Now we have 2 files.  The old file (pre-edit without changes) and the new file (post-edit with changes) 
	//Run a diff command on the old file versus the newly edited file. This will give us the exact change(s) made. Save as a diff file
	$command = "diff ".$locationOfOcrFile." ".$locationOfLogFiles."/".$preEditFileName." > ".$locationOfLogFiles."/".$preEditFileName."~diff"; //cd "realpath(__DIR__);
	//echo $command;
	echo executeRemoteCommand($command);
	
	//This is to prevent the refresh bug
	$_SESSION['indicator'] = "processed"; 
}


//NORMAL EXECUTION:
//Display the contents of the file that the user wants to make changes to
echo "
<div class='row'>

    <div class='col-md-offset-1 col-md-5 text-center'>
        <form>
            <div class='form-group'>
                <textarea class='form-control text-right' rows='35' readonly>
                " .
	            file_get_contents($locationOfOcrFile)
	            . "
                </textarea>
            </div>
        </form>
	<button type='button' class='btn btn-primary btn-lg'>סוויטש מיינונג</button>
    </div>

    <div class='col-md-5 text-center'>
        <form action='user.php' method='POST'>
            <div class='form-group text-right'>
                <textarea class='form-control text-right' rows='35' name='editedText'>
	            " .
	            file_get_contents($locationOfOcrFile)
	            . "
	        </textarea>
            </div>
			<button type='submit' name='ocrMakeChange'>Submit OCR Changes</button>
        </form>
        <button type='button'
                class='btn btn-primary btn-lg' 
                data-toggle='modal'
                data-target='.bs-example-modal-lg'>פאָרלייגן</button>
        <div class='modal fade bs-example-modal-lg' tabindex='-1' role='dialog' aria-labelledby='myLargeModalLabel' aria-hidden='true'>
            <div class='modal-dialog modal-lg'>
    	        <div class='modal-content'>
		    ...
		</div>
	    </div>
	</div>
    </div>
</div>

<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
";


?>


</body>
</html>


